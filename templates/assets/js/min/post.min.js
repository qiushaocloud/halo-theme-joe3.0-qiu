const postContext={limited:false,initCopy(){if(PageAttrs.metas_enable_copy==="false"||!ThemeConfig.enable_copy)return;const l=location.href;const c=$(".joe_detail").attr("data-author");const r=$(".joe_detail").attr("data-author-username");const d=$(".joe_detail .joe_detail__title").text();const p=$("html head meta[name=description]").attr("content");$(".joe_detail__article").on("copy",function(e){const t=window.getSelection();const o=t.toString().replace(/<已自动折叠>/g,"");const n=(ThemeConfig.enable_copy_right_text&&!(r&&window.Joe.getLoginedUserInfo().username===r)?ThemeConfig.copy_right_text||`\r\n\r\n====================================\r\n文章作者： ${c}\r\n文章来源： ${ThemeConfig.blog_title}(${ThemeConfig.blog_url})\r\n文章标题： ${d}\r\n文章链接： ${l}\r\n版权声明： 内容遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。`:"").replace(/{postUrl}/g,l).replace(/{postTitle}/g,d).replace(/{postAuthor}/g,c).replace(/{BlogTitle}/g,ThemeConfig.blog_title).replace(/{BlogUrl}/g,ThemeConfig.blog_url).replace(/{postDescription}/g,p);if(window.clipboardData){const i=o+n;window.clipboardData.setData("Text",i);return false}else{const a=document.body;const i=o+n;const s=document.createElement("pre");s.style.position="absolute";s.style.left="-99999px";a.appendChild(s);s.innerText=i;t.selectAllChildren(s);setTimeout(function(){a.removeChild(s)},0)}})},initShare(){if(PageAttrs.metas_enable_share==="false"||!ThemeConfig.enable_share)return;if(ThemeConfig.enable_share_link&&$(".icon-share-link").length){$(".icon-share-link").each((e,t)=>{const o=$(t)[0];const n=o.dataset.postTitle;const i=o.dataset.postDescription;const a=o.dataset.postAuthor;const s=o.dataset.template;let l=window.location.href;if(s){l=s.replace(/{postUrl}/g,location.href).replace(/{postTitle}/g,n).replace(/{postAuthor}/g,a).replace(/{postDescription}/g,i).replace(/{BlogTitle}/g,ThemeConfig.blog_title).replace(/{BlogUrl}/g,ThemeConfig.blog_url);if(!/{postUrl}/.test(s)){l+=` ，文章链接: ${location.href}`}}new ClipboardJS(o,{text:()=>l}).on("success",()=>Qmsg.success("文章链接已复制"))})}if(ThemeConfig.enable_share_weixin&&$(".qrcode_wx").length){$(".qrcode_wx").qrcode({width:140,height:140,render:"canvas",typeNumber:-1,correctLevel:0,background:"#ffffff",foreground:"#000000",text:location.href})}},initLike(){if(PageAttrs.metas_enable_like==="false"||!ThemeConfig.enable_like||!$(".joe_detail__agree").length)return;const a=$(".joe_detail").attr("data-cid");const s=+($(".joe_detail").attr("data-clikes")||0);let l=localStorage.getItem(encryption("agree"))?JSON.parse(decrypt(localStorage.getItem(encryption("agree")))):[];let c=l.includes(a);const r=$(".joe_detail__agree, .post-operate-like");const d=r.find(".icon-like");const p=r.find(".icon-unlike");const h=r.find(".nums");if(c){p.addClass("active")}else{d.addClass("active")}h.html(s);let t=false;d.on("click",function(e){e.stopPropagation();if(t)return;t=true;l=localStorage.getItem(encryption("agree"))?JSON.parse(decrypt(localStorage.getItem(encryption("agree")))):[];c=l.includes(a);$.ajax({url:"/apis/api.halo.run/v1alpha1/trackers/upvote",type:"post",contentType:"application/json; charset=utf-8",data:JSON.stringify({group:"content.halo.run",plural:"posts",name:a})}).then(e=>{let t=s;if(c){t--;const i=l.findIndex(e=>e===a);l.splice(i,1);p.removeClass("active");d.addClass("active");r.removeClass("active")}else{t++;l.push(a);d.removeClass("active");p.addClass("active");r.addClass("active")}const o=encryption("agree");const n=encryption(JSON.stringify(l));localStorage.setItem(o,n);h.html(t).show()}).catch(e=>{t=false})})},initToc(e){if(PageAttrs.metas_enable_toc==="false"||!ThemeConfig.enable_toc||!$(".toc-container").length)return;if(PageAttrs.metas_use_raw_content==="true"){$("#js-toc").html('<div class="toc-nodata">暂不支持解析原始内容目录</div>');$(".toc-container").show();return}if(PageAttrs.metas_enable_read_limit==="true"&&!e&&postContext.limited){$("#js-toc").html('<div class="toc-nodata">文章内容不完整，目录仅评论后可见</div>');$(".toc-container").show();return}const t=$("html");const o=$(".joe_header__mask");const n=$(".joe_action .toc");const i=$(".joe_header__toc");const a=$("#js-toc");const s=$("#js-toc-mobile");tocbot.init({tocSelector:Joe.isMobile?"#js-toc-mobile":"#js-toc",contentSelector:".joe_detail__article",ignoreSelector:".js-toc-ignore",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:+(PageAttrs.metas_toc_depth||ThemeConfig.toc_depth||0),scrollSmooth:true,includeTitleTags:true,hasInnerContainers:false,headingsOffset:80,scrollSmoothOffset:-80,positionFixedSelector:".toc-container",positionFixedClass:"is-position-fixed",fixedSidebarOffset:"auto",onClick:function(e){if(Joe.isMobile){t.removeClass("disable-scroll");i.removeClass("active");o.removeClass("active slideout")}window.tocPhase=true},scrollEndCallback:function(e){window.tocPhase=null}});if(Joe.isMobile){!s.children().length&&s.html('<div class="toc-nodata"><em></em>暂无目录</div>')}else{!a.children().length&&a.html('<div class="toc-nodata">暂无目录</div>')}if(Joe.isMobile){n.show();n.on("click",()=>{window.sessionStorage.setItem("lastScroll",t.scrollTop());t.addClass("disable-scroll");o.addClass("active slideout");i.addClass("active")})}$(".toc-container").show()},initAsideOperate(){$(".post-operate-comment").on("click",function(e){const t=document.querySelector(".joe_comment");const o=document.querySelector(".joe_header");if(!t||!o)return;e.stopPropagation();if(!Boolean(document.querySelector('[id*="comment-"]'))&&!Boolean(document.querySelector("#waline"))){Qmsg.warning("评论功能不可用！");return}const n=t.offsetTop-o.offsetHeight-15;window.scrollTo({top:n})});if(Joe.isMobile)return;const o=$(".aside_operations");const n=$(".joe_detail__agree,.joe_detail__operate-share,.joe_detail__operate .joe_donate");const e=e=>{const t=$(".joe_post")[0].getBoundingClientRect().left;if(t<75){o.hide();n.show()}else{o.show();n.hide()}};e();window.addEventListener("resize",Utils.throttle(e),500)},initProgress(){if(!ThemeConfig.enable_progress_bar)return;$(window).off("scroll");const t=$(".joe_progress_bar");let o,n,i;const a=e=>t.css("width",e*100+"%");$(window).on("scroll",function(e){e.stopPropagation();o=$(window).height();n=$("body").height();i=n-o;window.requestAnimationFrame(function(){const e=Math.max(0,Math.min(1,$(window).scrollTop()/i));a(e)})})},initVideo(){if($(".joe_detail__article-video").length){const o=$(".joe_detail__article-video .play iframe").attr("data-player");$(".joe_detail__article-video .episodes .item").on("click",function(e){e.stopPropagation();$(this).addClass("active").siblings().removeClass("active");const t=$(this).attr("data-src");$(".joe_detail__article-video .play iframe").attr({src:o+t})});$(".joe_detail__article-video .episodes .item").first().click()}},async jumpToComment(){if(ThemeConfig.enable_clean_mode||!ThemeConfig.enable_comment||PageAttrs.metas_enable_comment==="false")return;const{cid:e="",p:t=""}=Utils.getUrlParams();if(!e)return;await Utils.sleep(1e3);try{const o=document.getElementsByTagName("halo-comment");if(!o)return;const n=$(o[0].shadowRoot.getElementById("halo-comment")).find("#comment-"+e);if(!n)return;const i=n.offset().top-50;window.scrollTo({top:i});const a=n.find(".markdown-content").eq(0);a.addClass("blink");await Utils.sleep(2e3);a.removeClass("blink");window.history.replaceState(null,null,t?`?p=${t}`:location.origin+location.pathname);tocbot.refresh()}catch(e){console.info(e)}}};!function(){const t=["jumpToComment"];document.addEventListener("DOMContentLoaded",function(){Object.keys(postContext).forEach(e=>!t.includes(e)&&typeof postContext[e]==="function"&&postContext[e]())});window.addEventListener("load",function(){if(t.length===1){postContext[t[0]]()}else{t.forEach(e=>e!=="loadingBar"&&postContext[e]&&postContext[e]())}})}();